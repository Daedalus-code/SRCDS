#!/bin/bash

################################################################################
#
# SRCDS Tools & Options
# Author: Daedalus-code
#
# License: GNU General Public License v3.0
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this script. If not, see <https://www.gnu.org/licenses/>.
#
################################################################################

# tools & options
function srcds_options() {
  while true; do
    HEIGHT="13"
    WIDTH="54"
    CHOICE_HEIGHT="6"
    MENU="SRCDS Tools & Options"

    OPTIONS=(
      1 "Bots             Bot management options"
      2 "Data Usage       Monitor network data"
      3 "crontab          Manage scheduled tasks"
      4 "ncdu             NCurses disk usage viewer"
      5 "FastDL           Faster map downloads"
      6 "Random           Password generator"
    )

    CHOICE=$(dialog --clear \
      --menu "$MENU" \
      $HEIGHT $WIDTH $CHOICE_HEIGHT \
      "${OPTIONS[@]}" \
      3>&1 1>&2 2>&3)
    EXIT_STATUS=$?
    clear

    # Exit loop if Cancel/ESC pressed
    if [ $EXIT_STATUS -ne 0 ]; then
      break
    fi

    case $CHOICE in

    "1")

      ##########################################################################
      # bot options
      ##########################################################################

      mkdir -p "$SRCDS_DIR"/"$SERVER_GAME"/custom/bots
      BOTDIR="$SRCDS_DIR/$SERVER_GAME/custom/bots"

      # copy over extra db if not found
      if [[ ! -f "$BOTDIR"/Realistic_AI.db ]]; then
        cp "$HOME"/bin/include/extra/bots/Realistic_AI.db "$BOTDIR"
      fi

      HEIGHT="10"
      WIDTH="60"
      CHOICE_HEIGHT="3"
      MENU="Bot Options"

      OPTIONS=(
        1 "New Bots       Generate new bot profiles"
        2 "Names.txt      Manage names for bot generation"
        3 "Switch DB      Switch active bot profile database"
      )

      CHOICE=$(dialog --clear \
        --menu "$MENU" \
        $HEIGHT $WIDTH $CHOICE_HEIGHT \
        "${OPTIONS[@]}" \
        2>&1 >/dev/tty)

      clear
      case $CHOICE in

      "1")

        srcds_bots
        ;;

      "2")

        dialog --msgbox "Sorting $(wc -l "$BOTDIR"/names.txt | awk '{ print $1 }') names, keeping uniq" 5 "$(echo "$(wc -L "$BOTDIR"/names.txt | awk '{ print $1 }')+20" | bc 2>/dev/null)"
        echo "$(cat "$BOTDIR"/names.txt 2>/dev/null | sort | uniq)" >/tmp/nm.tmp
        mv /tmp/nm.tmp "$BOTDIR"/names.txt
        nano "$BOTDIR"/names.txt
        ;;

      "3")

        # check that the directory exists
        [[ -d "$BOTDIR" ]] || {
          echo "Bot directory not found: $BOTDIR"
        }

        # function to count names in a db
        count_names() {
          DB_FILE="$1"
          [[ -f "$DB_FILE" ]] || {
            echo 0
            return
          }
          grep "+" "$DB_FILE" | grep -v "=" | wc -l
        }

        # get current active db
        ACTIVE_DB="$BOTDIR/botprofile.db"

        # build menu dynamically with columns
        MENU=()
        i=1
        MAX_NAME_LEN=20 # adjust as needed for column width
        for DB in "$BOTDIR"/*.db; do
          [[ -f "$DB" ]] || continue
          NAME=$(basename "$DB")
          COUNT=$(count_names "$DB")
          ACTIVE=""
          [[ "$DB" == "$ACTIVE_DB" ]] && ACTIVE="<- Active"
          # column formatting: name | count | active
          LABEL=$(printf "%-${MAX_NAME_LEN}s %5s %s" "$NAME" "Names: $COUNT" "$ACTIVE")
          MENU+=("$i" "$LABEL")
          ((i++))
        done

        TOTAL_PROFILES=$(ls "$BOTDIR"/*.db 2>/dev/null | wc -l)
        LENGTH="$((TOTAL_PROFILES + 7))"
        # calculate WIDTH dynamically based on longest LABEL
        WIDTH=$(printf "%s\n" "${MENU[@]}" | awk '{print length($0)}' | sort -nr | head -n1)
        WIDTH=$((WIDTH + 11))

        # show dialog menu
        CHOICE=$(dialog --menu "Profiles available: $TOTAL_PROFILES" "$LENGTH" "$WIDTH" 10 "${MENU[@]}" 3>&1 1>&2 2>&3)
        EXIT_STATUS=$?
        clear

        # exit immediately on Cancel/ESC
        if [ $EXIT_STATUS -ne 0 ]; then
          continue
        fi

        # get the selected DB path
        SELECTED_DB=$(ls "$BOTDIR"/*.db | sed -n "${CHOICE}p")
        SELECTED_NAME=$(basename "$SELECTED_DB")

        # skip if already active
        if [[ "$SELECTED_DB" != "$ACTIVE_DB" ]]; then
          # move selected DB to botprofile.db
          cp "$SELECTED_DB" "${BOTDIR}_2"
          mv "$SELECTED_DB" "$BOTDIR/botprofile.db"
        fi
        dialog --msgbox "Bot profile updated $SELECTED_NAME" 5 50
        ;;
      esac
      ;;

      ##########################################################################

    "2")

      data_usage
      ;;

    "3")
      dialog --msgbox "Awards generation and database cleanup (daily at midnight)
Server restart check (every 5 minutes)
Daemon restart check (every 5 minutes)

15 00 * * * cd $HOME/HLstatsX && ./hlstats-awards.pl >>$HOME/bin/include/cron.log 2>&1
*/5 * * * * cd $HOME/HLstatsX && ./run_hlstats start >>$HOME/bin/include/cron.log 2>&1
*/5 * * * * cd $HOME/bin/include && ./start_srcds >>$HOME/bin/include/cron.log 2>&1" 11 105
      crontab -e
      ;;

    "4")

      ncdu "$HOME"
      ;;

    "5")

      # local map directory
      MAP_DIR="$SRCDS_DIR/$SERVER_GAME/maps"

      function compress_maps() {
        find "$MAP_DIR" -name "*.bsp" -exec sh -c '[ ! -f "$1.bz2" ] && bzip2 -k -1 "$1"' sh {} \;
      }

      while true; do
        ACTION=$(
          dialog --no-cancel --clear --title "FastDL Menu" \
            --menu "" 11 61 6 \
            1 "Status           Display FastDL overview" \
            2 "Compress         Compress .bsp map files" \
            3 "Synchronize      Synchronize files (SSH required)" \
            4 "Mapfiles         Display maps for the VPS" \
            0 "Exit             Return to the main menu" \
            3>&1 1>&2 2>&3
        )

        case $ACTION in

        "1")

          # fastDL status check
          NUM_BSP=$(ls "$MAP_DIR"/*.bsp 2>/dev/null | wc -l)
          NUM_COMPRESSED=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | wc -l)

          TOTAL_BSP_BYTES=$(find "$MAP_DIR" -type f -name "*.bsp" -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
          TOTAL_BSP_HUMAN=$(awk -v size="$TOTAL_BSP_BYTES" 'BEGIN{if(size<1024){print size " B"} else if(size<1048576){printf "%.1f KB", size/1024} else if(size<1073741824){printf "%.1f MB", size/1048576} else {printf "%.1f GB", size/1073741824}}')
          TOTAL_BZ2_BYTES=$(find "$MAP_DIR" -type f -name "*.bsp.bz2" -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
          TOTAL_BZ2_HUMAN=$(awk -v size="$TOTAL_BZ2_BYTES" 'BEGIN{if(size<1024){print size " B"} else if(size<1048576){printf "%.1f KB", size/1024} else if(size<1073741824){printf "%.1f MB", size/1048576} else {printf "%.1f GB", size/1073741824}}')

          FASTDL_DWN_URL=$(grep -m1 "sv_downloadurl" "$SRCDS_DIR/$SERVER_GAME/cfg/server.cfg" | awk '{print $NF}' | tr -d '"')

          [[ "$FASTDL_DWN_URL" != */ ]] && FASTDL_DWN_URL="$FASTDL_DWN_URL/"

          ONLINE_MAP_CHECK=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | head -n1 | xargs -n1 basename)

          FASTDL_STATUS="No maps"
          FASTDL_SPEED="N/A"

          if [[ -n "$ONLINE_MAP_CHECK" ]]; then
            if curl -fsI "$FASTDL_DWN_URL/maps/$ONLINE_MAP_CHECK" >/dev/null; then
              FASTDL_STATUS="OK"
              FASTDL_SPEED=$(curl -o /dev/null -s -w "%{speed_download}" "$FASTDL_DWN_URL/maps/$ONLINE_MAP_CHECK" | awk '{printf "%.1f KB/s", $1/1024}')
              # track value for average
              echo "$FASTDL_SPEED" >>/tmp/fdlsp.tmp
              echo "$(tail -10 /tmp/fdlsp.tmp 2>/dev/null)" >/tmp/fdlsp.tmp
              TOT_FASTDL_SPEED="$(awk '{sum += $1} END {print sum}' /tmp/fdlsp.tmp 2>/dev/null)"
              TOT_FASTDL_SPEED_COUNT="$(wc -l /tmp/fdlsp.tmp 2>/dev/null | awk '{ print $1 }')"
              AVG_FASTDL_SPEED="Average: $(echo "$TOT_FASTDL_SPEED/$TOT_FASTDL_SPEED_COUNT" | bc 2>/dev/null) KB/s"
            else
              FASTDL_STATUS="Offline, no maps on server!"
              AVG_FASTDL_SPEED=""
            fi
          fi

          # dialog output
          FASTDL_MAPS="$NUM_COMPRESSED (.bsp.bz2)"
          FASTDL_SIZE="$TOTAL_BZ2_HUMAN (.bsp.bz2) / $TOTAL_BSP_HUMAN (.bsp)"
          FASTDL_OUTPUT="FastDL Status.: $FASTDL_STATUS
FastDL URL....: $FASTDL_DWN_URL
Down Speed....: $FASTDL_SPEED $AVG_FASTDL_SPEED
Server Maps...: $FASTDL_MAPS
Total Size....: $FASTDL_SIZE"
          WIDTH=$(($(echo "$FASTDL_OUTPUT" | wc -L) + 5))
          dialog --msgbox "$FASTDL_OUTPUT" 9 "$WIDTH"
          ;;

        "2")

          # compress maps
          compress_maps
          NUM_COMPRESSED=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | wc -l)
          FASTDL_COM_OUTPUT="$NUM_COMPRESSED maps are now compressed (.bsp.bz2)"
          WIDTH="$(echo "$(echo "$FASTDL_COM_OUTPUT" | wc -L)+5" | bc 2>/dev/null)"
          dialog --msgbox "$NUM_COMPRESSED maps are now compressed (.bsp.bz2)" 5 "$WIDTH"
          ;;

        "3")

          # upload maps (rsync)
          VPS_USER=$(dialog --inputbox "Enter VPS SSH username:" 8 40 3>&1 1>&2 2>&3 3>&1)
          VPS_HOST=$(dialog --inputbox "Enter VPS hostname or IP:" 8 40 3>&1 1>&2 2>&3 3>&1)
          # default expected directory path
          VPS_FASTDL_DEFAULT="/var/www/html/cstrike"
          VPS_FASTDL_DIR=$(dialog --inputbox "Enter VPS FastDL directory (e.g., /var/www/html/cstrike):" 8 50 "$VPS_FASTDL_DEFAULT" 3>&1 1>&2 2>&3 3>&1)

          clear
          # compress maps before sync
          compress_maps
          # synchronize maps to vps server
          rsync -avz "$MAP_DIR/"*.bsp "$VPS_USER@$VPS_HOST:$VPS_FASTDL_DIR/maps/"
          rsync -avz "$MAP_DIR/"*.bsp.bz2 "$VPS_USER@$VPS_HOST:$VPS_FASTDL_DIR/maps/"

          FASTDL_UP_OUTPUT="$FASTDL_MAPS Maps uploaded to FastDL VPS."
          WIDTH="$(echo "$(echo "$FASTDL_UP_OUTPUT" | wc -L)+5" | bc 2>/dev/null)"
          dialog --msgbox "$FASTDL_UP_OUTPUT" 5 "$WIDTH"
          ;;

          # list maps

        "4")

          LIST_BSP_MAPS="$(ls -lSh "$MAP_DIR/"*.bsp 2>/dev/null)"
          LIST_BSP_COUNT="$(echo "$LIST_BSP_MAPS" | grep -v "total" | wc -l)"

          LIST_BZ2_MAPS="$(ls -lSh "$MAP_DIR/"*.bsp.bz2 2>/dev/null)"
          LIST_BZ2_COUNT="$(echo "$LIST_BZ2_MAPS" | grep -v "total" | wc -l)"

          dialog --title "Maps (.bsp): $LIST_BSP_COUNT" --msgbox "$LIST_BSP_MAPS" 20 0
          dialog --title "Maps (.bsp.bz2): $LIST_BZ2_COUNT" --msgbox "$LIST_BZ2_MAPS" 20 0
          ;;

        "0")

          clear
          return
          ;;
        esac
      done
      ;;

    "6")
      dialog --inputbox "Enter the number of characters:" 7 36 10 2>/tmp/psam.tmp
      EXIT_STATUS=$?
      PASS_AMOUNT="$(cat /tmp/psam.tmp 2>/dev/null)"

      # go back to main menu if Cancel/ESC or empty input
      if [ $EXIT_STATUS -ne 0 ] || [[ -z "$PASS_AMOUNT" ]]; then
        continue # return to main menu loop
      fi

      PASS_LENGTH=${1:-$PASS_AMOUNT}
      clear
      echo "Password length: $PASS_LENGTH

$(base64 </dev/urandom | head -c $PASS_LENGTH | rev | cut -c 2- | rev | tr -d '\n')
      "
      exit 0 # only exit if password was actually generated
      ;;
    esac
  done
  return 0
}

# END
