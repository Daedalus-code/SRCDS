#!/bin/bash

################################################################################
#
# SRCDS Tools & Options
# Author: Daedalus-code
#
# License: GNU General Public License v3.0
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this script. If not, see <https://www.gnu.org/licenses/>.
#
################################################################################

source "$HOME/bin/include/srcds.conf"

################################################################################
# generate bots
################################################################################

function srcds_bots() {

  BOT_DIFFICULTY=$(grep -E "^bot_difficulty" "$SRCDS_DIR/$SERVER_GAME/cfg/server.cfg" | awk '{print $2}')
  BOT_DIFFICULTY=${BOT_DIFFICULTY:-2}

  if [[ ! -s "$BOTDIR/names.txt" ]]; then
    dialog --msgbox "No names found in names.txt!" 5 32
    return 1
  fi

  mapfile -t NAMES <"$BOTDIR/names.txt"

  select_random() {
    local ARR=("$@")
    echo "${ARR[$((RANDOM % ${#ARR[@]}))]}"
  }

  rand_range() { echo $((RANDOM % ($2 - $1 + 1) + $1)); }
  rand_float() { awk -v min="$1" -v max="$2" 'BEGIN{srand(); printf "%.2f", min+rand()*(max-min)}'; }

  USED_NAMES=()

  ##############################################################################
  # name pools
  ##############################################################################

  NOOB_NAMES=()
  CASUAL_NAMES=()
  PRO_NAMES=()
  ELITE_NAMES=()
  NEUTRAL_NAMES=()

  for N in "${NAMES[@]}"; do
    case "$N" in
    noob_*) NOOB_NAMES+=("${N#noob_}") ;;
    casual_*) CASUAL_NAMES+=("${N#casual_}") ;;
    pro_*) PRO_NAMES+=("${N#pro_}") ;;
    elite_*) ELITE_NAMES+=("${N#elite_}") ;;
    *) NEUTRAL_NAMES+=("$N") ;;
    esac
  done

  get_unique_name() {
    local POOL=("$@")
    [[ ${#POOL[@]} -eq 0 ]] && POOL=("${NAMES[@]}")
    local NAME
    while true; do
      NAME=$(select_random "${POOL[@]}")
      [[ ! " ${USED_NAMES[*]} " =~ " $NAME " ]] && break
    done
    USED_NAMES+=("$NAME")
    echo "$NAME"
  }

  ##############################################################################
  # ask bot count
  ##############################################################################

  dialog --inputbox "($(wc -l "$BOTDIR/names.txt" | awk '{print $1 }')) Names | Enter number:" 7 46 20 2>/tmp/bot_count
  NUM_PROFILES=$(cat /tmp/bot_count)
  [[ -z "$NUM_PROFILES" || "$NUM_PROFILES" -le 0 ]] && return 1

  ##############################################################################
  # header
  ##############################################################################

  cat >botprofile.db <<'EOF'
Default
    Skill = 50
    Aggression = 50
    ReactionTime = 0.3
    Teamwork = 75
    Cost = 0
End

Template Easy
    Difficulty = EASY
End

Template Normal
    Difficulty = NORMAL
End

Template Hard
    Difficulty = HARD
End

Template Expert
    Difficulty = EXPERT
End

Template Rifle
    WeaponPreference = ak47
    WeaponPreference = m4a1
    WeaponPreference = galil
    WeaponPreference = famas
    WeaponPreference = sg552
    WeaponPreference = aug
    WeaponPreference = deagle
End

Template Sniper
    WeaponPreference = awp
End

Template Shotgun
    WeaponPreference = xm1014
    WeaponPreference = m3
End

Template Spray
    WeaponPreference = p90
    WeaponPreference = mp5
    WeaponPreference = mac10
    WeaponPreference = ump
End

Template Knife
    WeaponPreference = knife
End
EOF

  ##############################################################################
  # difficulty distribution (IMPORTANT)
  ##############################################################################

  case "$BOT_DIFFICULTY" in
  1) DIFF_POOL=(Easy Easy Normal Normal Hard) ;;
  2) DIFF_POOL=(Easy Normal Normal Hard Expert) ;;
  3) DIFF_POOL=(Normal Hard Hard Expert Expert) ;;
  esac

  ##############################################################################
  # generate bots
  ##############################################################################

  (
    for ((i = 1; i <= NUM_PROFILES; i++)); do

      DIFF=$(select_random "${DIFF_POOL[@]}")

      # name â†’ personality bias
      NAME_POOL=("${NEUTRAL_NAMES[@]}")
      [[ "$DIFF" == "Easy" ]] && NAME_POOL+=("${NOOB_NAMES[@]}")
      [[ "$DIFF" == "Normal" ]] && NAME_POOL+=("${CASUAL_NAMES[@]}")
      [[ "$DIFF" == "Hard" ]] && NAME_POOL+=("${PRO_NAMES[@]}")
      [[ "$DIFF" == "Expert" ]] && NAME_POOL+=("${ELITE_NAMES[@]}")

      NAME=$(get_unique_name "${NAME_POOL[@]}")

      SKIN=$((RANDOM % 5))
      VOICE=$((RANDOM % 44 + 85))

      # global stat variance (shared by ALL)
      SKILL=$(rand_range 15 95)
      AGGR=$(rand_range 15 95)
      REACT=$(rand_float 0.18 0.65)

      # personality roll
      PERSONALITY=$(select_random \
        generalist generalist \
        rifle_main rifle_main \
        awp_freak \
        shotgun_rat \
        sprayer \
        knife_maniac)

      case "$PERSONALITY" in
      generalist) WEAPON=$(select_random Rifle Spray Shotgun) ;;
      rifle_main) WEAPON="Rifle" ;;
      awp_freak) WEAPON="Sniper" ;;
      shotgun_rat) WEAPON="Shotgun" ;;
      sprayer) WEAPON="Spray" ;;
      knife_maniac)
        WEAPON="Knife"
        AGGR=$(rand_range 80 100)
        SKILL=$(rand_range 10 40)
        ;;
      esac

      cat >>botprofile.db <<EOF
$DIFF+$WEAPON "$NAME"
    Skill = $SKILL
    Aggression = $AGGR
    ReactionTime = $REACT
    Skin = $SKIN
    VoicePitch = $VOICE
End

EOF

      echo $((i * 100 / NUM_PROFILES))
      echo "Generating bot $i of $NUM_PROFILES"
    done
  ) | dialog --gauge "Generating bot profiles..." 6 50 0

  ##############################################################################
  # install
  ##############################################################################

  dialog --msgbox "Bot profile generation complete!" 5 36
  dialog --yesno "Install generated botprofile.db?" 5 40
  if [[ $? -eq 0 ]]; then
    mkdir -p "$SRCDS_DIR/$SERVER_GAME/custom/bots"
    RAND_SUFFIX=$((RANDOM % 10000))
    mv botprofile.db "$SRCDS_DIR/$SERVER_GAME/custom/bots/botprofile_$RAND_SUFFIX.db"
    dialog --msgbox "Installed as botprofile_$RAND_SUFFIX.db\nBots: $NUM_PROFILES" 6 44
  fi
}

# END
