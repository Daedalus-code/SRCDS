#!/bin/bash

################################################################################
#
# SRCDS Tools & Options
# Author: Daedalus-code
#
# License: GNU General Public License v3.0
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this script. If not, see <https://www.gnu.org/licenses/>.
#
################################################################################

source "$HOME/bin/include/srcds.conf"

################################################################################

mkdir -p "$SRCDS_DIR"/"$SERVER_GAME"/custom/bots
BOTDIR="$SRCDS_DIR/$SERVER_GAME/custom/bots"

################################################################################
# bot generate
################################################################################

function srcds_bot_generate() {

  BOT_DIFFICULTY=$(grep -E "^bot_difficulty" "$SRCDS_DIR/$SERVER_GAME/cfg/server.cfg" | awk '{print $2}')
  BOT_DIFFICULTY=${BOT_DIFFICULTY:-2}

  mapfile -t NAMES <"$BOTDIR/names.txt" || return 1

  select_random() {
    local A=("$@")
    echo "${A[$((RANDOM % ${#A[@]}))]}"
  }
  rand_range() { echo $((RANDOM % ($2 - $1 + 1) + $1)); }
  rand_float() { awk -v a="$1" -v b="$2" 'BEGIN{srand();printf "%.2f",a+rand()*(b-a)}'; }

  USED_NAMES=()

  ##############################################################################
  # name pools
  ##############################################################################

  NOOB_NAMES=()
  CASUAL_NAMES=()
  PRO_NAMES=()
  ELITE_NAMES=()
  NEUTRAL_NAMES=()

  for N in "${NAMES[@]}"; do
    case "$N" in
    noob_* | eco_* | panic_*) NOOB_NAMES+=("${N#*_}") ;;
    casual_*) CASUAL_NAMES+=("${N#casual_}") ;;
    pro_*) PRO_NAMES+=("${N#pro_}") ;;
    elite_* | smurf_*) ELITE_NAMES+=("${N#*_}") ;;
    *) NEUTRAL_NAMES+=("$N") ;;
    esac
  done

  get_unique_name() {
    local POOL=("$@")
    while :; do
      N=$(select_random "${POOL[@]}")
      [[ ! " ${USED_NAMES[*]} " =~ " $N " ]] && break
    done
    USED_NAMES+=("$N")
    echo "$N"
  }

  ##############################################################################
  # bot count
  ##############################################################################

  dialog --inputbox "Bots to generate:" 7 40 24 2>/tmp/bot_count
  NUM_PROFILES=$(</tmp/bot_count)
  [[ -z "$NUM_PROFILES" || "$NUM_PROFILES" -le 0 ]] && return 1

  ##############################################################################
  # header
  ##############################################################################

  cat >botprofile.db <<'EOF'
Default
    Skill = 50
    Aggression = 50
    ReactionTime = 0.3
    Teamwork = 75
    Cost = 0
End

Template Easy    Difficulty = EASY    End
Template Normal  Difficulty = NORMAL  End
Template Hard    Difficulty = HARD    End
Template Expert  Difficulty = EXPERT  End

Template Rifle
    WeaponPreference = ak47
    WeaponPreference = m4a1
    WeaponPreference = galil
    WeaponPreference = famas
    WeaponPreference = deagle
End

Template Sniper  WeaponPreference = awp End
Template Shotgun WeaponPreference = xm1014 WeaponPreference = m3 End
Template Spray   WeaponPreference = p90 WeaponPreference = mp5 WeaponPreference = mac10 End
Template Knife   WeaponPreference = knife End

Template Eco
    WeaponPreference = glock
    WeaponPreference = usp
    WeaponPreference = p228
    WeaponPreference = deagle
    Cost = 1
End
EOF

  ##############################################################################
  # difficulty distribution
  ##############################################################################

  case "$BOT_DIFFICULTY" in
  1) DIFF_POOL=(Easy Easy Normal Normal Hard) ;;
  2) DIFF_POOL=(Easy Normal Normal Hard Expert) ;;
  3) DIFF_POOL=(Normal Hard Hard Expert Expert) ;;
  esac

  ##############################################################################
  # generate
  ##############################################################################

  (
    for ((i = 1; i <= NUM_PROFILES; i++)); do

      DIFF=$(select_random "${DIFF_POOL[@]}")

      NAME_POOL=("${NEUTRAL_NAMES[@]}")
      [[ "$DIFF" == "Easy" ]] && NAME_POOL+=("${NOOB_NAMES[@]}")
      [[ "$DIFF" == "Normal" ]] && NAME_POOL+=("${CASUAL_NAMES[@]}")
      [[ "$DIFF" == "Hard" ]] && NAME_POOL+=("${PRO_NAMES[@]}")
      [[ "$DIFF" == "Expert" ]] && NAME_POOL+=("${ELITE_NAMES[@]}")

      NAME=$(get_unique_name "${NAME_POOL[@]}")

      SKIN=$((RANDOM % 5))
      VOICE=$((RANDOM % 44 + 85))

      # global variance
      SKILL=$(rand_range 15 95)
      AGGR=$(rand_range 15 95)
      REACT=$(rand_float 0.18 0.65)

      ##########################################################################
      # NAME-BASED HARD LOCKS (absolute priority)
      ##########################################################################

      case "$NAME" in
      awp_*)
        WEAPON="Sniper"
        ;;
      knife_*)
        WEAPON="Knife"
        AGGR=95
        SKILL=$(rand_range 10 40)
        ;;
      eco_*)
        WEAPON="Eco"
        SKILL=$(rand_range 15 40)
        AGGR=$(rand_range 20 40)
        REACT=$(rand_float 0.35 0.60)
        ;;
      panic_*)
        WEAPON=$(select_random Rifle Spray)
        AGGR=$(rand_range 5 20)
        REACT=$(rand_float 0.18 0.25)
        ;;
      smurf_*)
        DIFF="Easy"
        WEAPON=$(select_random Rifle Sniper)
        SKILL=$(rand_range 85 95)
        AGGR=$(rand_range 70 90)
        REACT=$(rand_float 0.18 0.22)
        ;;
      *)
        PERSONALITY=$(select_random \
          generalist generalist \
          rifle_main rifle_main \
          awp_freak \
          shotgun_rat \
          sprayer \
          panic_bot \
          eco_bot \
          knife_maniac)

        case "$PERSONALITY" in
        generalist) WEAPON=$(select_random Rifle Spray Shotgun) ;;
        rifle_main) WEAPON="Rifle" ;;
        awp_freak) WEAPON="Sniper" ;;
        shotgun_rat) WEAPON="Shotgun" ;;
        sprayer) WEAPON="Spray" ;;
        eco_bot)
          WEAPON="Eco"
          SKILL=$(rand_range 15 35)
          ;;
        panic_bot)
          WEAPON=$(select_random Rifle Spray)
          AGGR=$(rand_range 5 25)
          REACT=$(rand_float 0.18 0.25)
          ;;
        knife_maniac)
          WEAPON="Knife"
          AGGR=100
          SKILL=$(rand_range 10 35)
          ;;
        esac
        ;;
      esac

      cat >>botprofile.db <<EOF
$DIFF+$WEAPON "$NAME"
    Skill = $SKILL
    Aggression = $AGGR
    ReactionTime = $REACT
    Skin = $SKIN
    VoicePitch = $VOICE
End

EOF

      echo $((i * 100 / NUM_PROFILES))
      echo "Generating bot $i"
    done
  ) | dialog --gauge "Generating bot profiles..." 6 50 0

  ##############################################################################
  # install
  ##############################################################################

  dialog --msgbox "Bot profile generation complete!" 5 36
  dialog --yesno "Install generated botprofile.db?" 5 40
  if [[ $? -eq 0 ]]; then
    # install bot profile
    mkdir -p "$SRCDS_DIR/$SERVER_GAME/custom/bots"
    RAND_SUFFIX=$((RANDOM % 10000))
    mv botprofile.db "$SRCDS_DIR/$SERVER_GAME/custom/bots/botprofile_$RAND_SUFFIX.db"
    dialog --msgbox "Installed as botprofile_$RAND_SUFFIX.db\nBots: $NUM_PROFILES" 6 44
  else
    # remove bot profile
    rm "$HOME"/botprofile.db &>/dev/null
  fi
  dialog --msgbox "Bot profiles generated!" 5 32
}

################################################################################
# bot names
################################################################################

function srcds_bot_names() {
  dialog --msgbox "Sorting $(wc -l "$BOTDIR"/names.txt | awk '{ print $1 }') names, keeping uniq" 5 "$(echo "$(echo "Sorting $(wc -l "$BOTDIR"/names.txt | awk '{ print $1 }') names, keeping uniq" | wc -L)+5" | bc 2>/dev/null)"
  echo "$(sed '/^[[:space:]]*$/d' "$BOTDIR"/names.txt 2>/dev/null | sort -u)" >/tmp/nm.tmp
  mv /tmp/nm.tmp "$BOTDIR"/names.txt
  nano "$BOTDIR"/names.txt
}

################################################################################
# switch bot profile
################################################################################

function srcds_bot_db_switch() {
  # check that the directory exists
  [[ -d "$BOTDIR" ]] || {
    echo "Bot directory not found: $BOTDIR"
  }

  # function to count names in a db
  count_names() {
    DB_FILE="$1"
    [[ -f "$DB_FILE" ]] || {
      echo 0
      return
    }
    grep "+" "$DB_FILE" | grep -v "=" | wc -l
  }

  # get current active db
  ACTIVE_DB="$BOTDIR/botprofile.db"

  # build menu dynamically with columns
  MENU=()
  i=1
  MAX_NAME_LEN=20 # adjust as needed for column width
  for DB in "$BOTDIR"/*.db; do
    [[ -f "$DB" ]] || continue
    NAME=$(basename "$DB")
    COUNT=$(count_names "$DB")
    ACTIVE=""
    [[ "$DB" == "$ACTIVE_DB" ]] && ACTIVE="<- Active"
    # column formatting: name | count | active
    LABEL=$(printf "%-${MAX_NAME_LEN}s %5s %s" "$NAME" "Names: $COUNT" "$ACTIVE")
    MENU+=("$i" "$LABEL")
    ((i++))
  done

  TOTAL_PROFILES=$(ls "$BOTDIR"/*.db 2>/dev/null | wc -l)
  LENGTH="$((TOTAL_PROFILES + 7))"
  # calculate WIDTH dynamically based on longest LABEL
  WIDTH=$(printf "%s\n" "${MENU[@]}" | awk '{print length($0)}' | sort -nr | head -n1)
  WIDTH=$((WIDTH + 11))

  # show dialog menu
  CHOICE=$(dialog --menu "Profiles available: $TOTAL_PROFILES" "$LENGTH" "$WIDTH" 10 "${MENU[@]}" 3>&1 1>&2 2>&3)
  EXIT_STATUS=$?
  clear

  # exit immediately on Cancel/ESC
  if [ $EXIT_STATUS -ne 0 ]; then
    return
  fi

  # get the selected DB path
  SELECTED_DB=$(ls "$BOTDIR"/*.db | sed -n "${CHOICE}p")
  SELECTED_NAME=$(basename "$SELECTED_DB")

  # skip if already active
  if [[ "$SELECTED_DB" != "$ACTIVE_DB" ]]; then
    # move selected DB to botprofile.db
    cp "$SELECTED_DB" "${BOTDIR}_2"
    mv "$SELECTED_DB" "$BOTDIR/botprofile.db"
  fi
  dialog --msgbox "Bot profile updated $SELECTED_NAME" 5 50
}

################################################################################
# edit bot profile
################################################################################

function srcds_bot_db_edit() {
  nano "$BOTDIR/botprofile.db"
}

################################################################################
# bots
################################################################################

function srcds_bots() {
  while true; do
    HEIGHT="12"
    WIDTH="60"
    CHOICE_HEIGHT="5"
    MENU="Bot Options"

    OPTIONS=(
      1 "New Bots       Generate new bot profiles"
      2 "Names.txt      Manage names for bot generation"
      3 "Switch DB      Switch active bot profile database"
      4 "Edit DB        Edit bot profile (expert)"
      0 "Back           Return to the tool menu"
    )

    CHOICE=$(dialog --clear \
      --no-cancel --menu "$MENU" \
      $HEIGHT $WIDTH $CHOICE_HEIGHT \
      "${OPTIONS[@]}" \
      2>&1 >/dev/tty)

    clear
    case $CHOICE in
    "1") srcds_bot_generate ;;  # generate bots
    "2") srcds_bot_names ;;     # names.txt
    "3") srcds_bot_db_switch ;; # switch bot profile
    "4") srcds_bot_db_edit ;;   # edit bot profile
    "0")

      clear
      return
      ;;
    esac
  done
}

# END
