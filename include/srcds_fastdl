#!/bin/bash

################################################################################
#
# SRCDS Tools & Options
# Author: Daedalus-code
#
# License: GNU General Public License v3.0
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this script. If not, see <https://www.gnu.org/licenses/>.
#
################################################################################

function srcds_fastdl() {

  # local map directory
  MAP_DIR="$SRCDS_DIR/$SERVER_GAME/maps"

  function compress_maps() {
    find "$MAP_DIR" -name "*.bsp" -exec sh -c '[ ! -f "$1.bz2" ] && bzip2 -k -1 "$1"' sh {} \;
  }

  while true; do
    ACTION=$(
      dialog --no-cancel --clear --title "FastDL Menu" \
        --menu "" 11 61 6 \
        1 "Status           Display FastDL overview" \
        2 "Compress         Compress .bsp map files" \
        3 "Synchronize      Synchronize files (SSH required)" \
        4 "Mapfiles         Display maps for the VPS" \
        0 "Back             Return to the tool menu" \
        3>&1 1>&2 2>&3
    )

    case $ACTION in

    ############################################################################
    # status
    ############################################################################

    "1")

      # fastDL status check
      NUM_BSP=$(ls "$MAP_DIR"/*.bsp 2>/dev/null | wc -l)
      NUM_COMPRESSED=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | wc -l)

      TOTAL_BSP_BYTES=$(find "$MAP_DIR" -type f -name "*.bsp" -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
      TOTAL_BSP_HUMAN=$(awk -v size="$TOTAL_BSP_BYTES" 'BEGIN{if(size<1024){print size " B"} else if(size<1048576){printf "%.1f KB", size/1024} else if(size<1073741824){printf "%.1f MB", size/1048576} else {printf "%.1f GB", size/1073741824}}')
      TOTAL_BZ2_BYTES=$(find "$MAP_DIR" -type f -name "*.bsp.bz2" -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
      TOTAL_BZ2_HUMAN=$(awk -v size="$TOTAL_BZ2_BYTES" 'BEGIN{if(size<1024){print size " B"} else if(size<1048576){printf "%.1f KB", size/1024} else if(size<1073741824){printf "%.1f MB", size/1048576} else {printf "%.1f GB", size/1073741824}}')

      FASTDL_DWN_URL=$(grep -m1 "sv_downloadurl" "$SRCDS_DIR/$SERVER_GAME/cfg/server.cfg" | awk '{print $NF}' | tr -d '"')

      [[ "$FASTDL_DWN_URL" != */ ]] && FASTDL_DWN_URL="$FASTDL_DWN_URL/"

      ONLINE_MAP_CHECK=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | head -n1 | xargs -n1 basename)

      FASTDL_STATUS="No maps"
      FASTDL_SPEED="N/A"

      if [[ -n "$ONLINE_MAP_CHECK" ]]; then
        if curl -fsI "$FASTDL_DWN_URL/maps/$ONLINE_MAP_CHECK" >/dev/null; then
          FASTDL_STATUS="OK"
          FASTDL_SPEED=$(curl -o /dev/null -s -w "%{speed_download}" "$FASTDL_DWN_URL/maps/$ONLINE_MAP_CHECK" | awk '{printf "%.1f KB/s", $1/1024}')
          # track value for average
          echo "$FASTDL_SPEED" >>/tmp/fdlsp.tmp
          echo "$(tail -10 /tmp/fdlsp.tmp 2>/dev/null)" >/tmp/fdlsp.tmp
          TOT_FASTDL_SPEED="$(awk '{sum += $1} END {print sum}' /tmp/fdlsp.tmp 2>/dev/null)"
          TOT_FASTDL_SPEED_COUNT="$(wc -l /tmp/fdlsp.tmp 2>/dev/null | awk '{ print $1 }')"
          AVG_FASTDL_SPEED="Average: $(echo "$TOT_FASTDL_SPEED/$TOT_FASTDL_SPEED_COUNT" | bc 2>/dev/null) KB/s"
        else
          FASTDL_STATUS="Offline, no maps on server!"
          AVG_FASTDL_SPEED=""
        fi
      fi

      # dialog output
      FASTDL_MAPS="$NUM_COMPRESSED (.bsp.bz2)"
      FASTDL_SIZE="$TOTAL_BZ2_HUMAN (.bsp.bz2) / $TOTAL_BSP_HUMAN (.bsp)"
      FASTDL_OUTPUT="FastDL Status.: $FASTDL_STATUS
FastDL URL....: $FASTDL_DWN_URL
Down Speed....: $FASTDL_SPEED $AVG_FASTDL_SPEED
Server Maps...: $FASTDL_MAPS
Total Size....: $FASTDL_SIZE"
      WIDTH=$(($(echo "$FASTDL_OUTPUT" | wc -L) + 5))
      dialog --msgbox "$FASTDL_OUTPUT" 9 "$WIDTH"
      ;;

      ##########################################################################
      # compress maps
      ##########################################################################

    "2")

      compress_maps
      NUM_COMPRESSED=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | wc -l)
      FASTDL_COM_OUTPUT="$NUM_COMPRESSED maps are now compressed (.bsp.bz2)"
      WIDTH="$(echo "$(echo "$FASTDL_COM_OUTPUT" | wc -L)+5" | bc 2>/dev/null)"
      dialog --msgbox "$NUM_COMPRESSED maps are now compressed (.bsp.bz2)" 5 "$WIDTH"
      ;;

      ##########################################################################
      # synchronize maps
      ##########################################################################

    "3")

      # upload maps (rsync)
      VPS_USER=$(dialog --inputbox "Enter VPS SSH username:" 8 40 3>&1 1>&2 2>&3 3>&1)
      VPS_HOST=$(dialog --inputbox "Enter VPS hostname or IP:" 8 40 3>&1 1>&2 2>&3 3>&1)
      # default expected directory path
      VPS_FASTDL_DEFAULT="/var/www/html/cstrike"
      VPS_FASTDL_DIR=$(dialog --inputbox "Enter VPS FastDL directory (e.g., /var/www/html/cstrike):" 8 50 "$VPS_FASTDL_DEFAULT" 3>&1 1>&2 2>&3 3>&1)

      clear
      # compress maps before sync
      compress_maps
      # synchronize maps to vps server
      rsync -avz "$MAP_DIR/"*.bsp "$VPS_USER@$VPS_HOST:$VPS_FASTDL_DIR/maps/"
      rsync -avz "$MAP_DIR/"*.bsp.bz2 "$VPS_USER@$VPS_HOST:$VPS_FASTDL_DIR/maps/"

      FASTDL_UP_OUTPUT="$FASTDL_MAPS Maps synchronized to FastDL VPS."
      WIDTH="$(echo "$(echo "$FASTDL_UP_OUTPUT" | wc -L)+5" | bc 2>/dev/null)"
      dialog --msgbox "$FASTDL_UP_OUTPUT" 5 "$WIDTH"
      ;;

      ##########################################################################
      # list maps
      ##########################################################################

    "4")

      # bsp
      LIST_BSP_MAPS="$(ls -lSh "$MAP_DIR/"*.bsp 2>/dev/null)"
      LIST_BSP_COUNT="$(echo "$LIST_BSP_MAPS" | grep -v "total" 2>/dev/null | wc -l)"
      # bos.bz2
      LIST_BZ2_MAPS="$(ls -lSh "$MAP_DIR/"*.bsp.bz2 2>/dev/null)"
      LIST_BZ2_COUNT="$(echo "$LIST_BZ2_MAPS" | grep -v "total" 2>/dev/null | wc -l)"

      dialog --title "Maps (.bsp): $LIST_BSP_COUNT" --msgbox "$LIST_BSP_MAPS" 20 0
      dialog --title "Maps (.bsp.bz2): $LIST_BZ2_COUNT" --msgbox "$LIST_BZ2_MAPS" 20 0
      ;;

    "0")

      clear
      return
      ;;
    esac
  done
}

# END
