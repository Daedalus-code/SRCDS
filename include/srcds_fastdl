#!/bin/bash

################################################################################
#
# License: GNU General Public License v3.0
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this script. If not, see <https://www.gnu.org/licenses/>.
#
################################################################################

function srcds_fastdl() {

  MAP_DIR="$SRCDS_DIR/$SERVER_GAME/maps"
  SOUND_DIR="$SRCDS_DIR/$SERVER_GAME/sound"

  # compress maps
  compress_maps() {
    find "$MAP_DIR" -name "*.bsp" \
      -exec sh -c '[ ! -f "$1.bz2" ] && bzip2 -k -1 "$1"' sh {} \;
  }
  # compress sound
  compress_sound() {
    find "$SOUND_DIR" \( -name "*.wav" -o -name "*.mp3" \) \
      -exec sh -c '[ ! -f "$1.bz2" ] && bzip2 -k -1 "$1"' sh {} \;
  }

  human_size() {
    awk -v size="$1" 'BEGIN{
      if (size < 1024) printf "%d B", size
      else if (size < 1048576) printf "%.1f KB", size/1024
      else if (size < 1073741824) printf "%.1f MB", size/1048576
      else printf "%.1f GB", size/1073741824
    }'
  }

  while true; do
    ACTION=$(
      dialog --no-cancel --clear --title "FastDL Menu" \
        --menu "" 11 61 5 \
        1 "Status           Display FastDL overview" \
        2 "Compress         Compress maps & sound" \
        3 "Synchronize      Synchronize files (SSH required)" \
        4 "Files            Display FastDL files" \
        0 "Back             Return to the tool menu" \
        3>&1 1>&2 2>&3
    )

    case $ACTION in

    ############################################################################
    # status
    ############################################################################

    "1")

      # maps
      NUM_BSP=$(ls "$MAP_DIR"/*.bsp 2>/dev/null | wc -l)
      NUM_BSP_BZ2=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | wc -l)
      # sound
      NUM_SOUND=$(find "$SOUND_DIR" \( -name "*.wav" -o -name "*.mp3" \) 2>/dev/null | wc -l)
      NUM_SOUND_BZ2=$(find "$SOUND_DIR" \( -name "*.wav.bz2" -o -name "*.mp3.bz2" \) 2>/dev/null | wc -l)

      # compressed maps percentage
      if ((NUM_BSP > 0)); then
        MAPS_COMP_PERC=$(awk -v c="$NUM_BSP_BZ2" -v t="$NUM_BSP" 'BEGIN{printf "%.0f", (c/t)*100}')
      else
        MAPS_COMP_PERC=0
      fi
      # compressed sound percentage
      if ((NUM_SOUND > 0)); then
        SOUND_COMP_PERC=$(awk -v c="$NUM_SOUND_BZ2" -v t="$NUM_SOUND" 'BEGIN{printf "%.0f", (c/t)*100}')
      else
        SOUND_COMP_PERC=0
      fi

      # maps bytes
      TOTAL_BSP_BYTES=$(find "$MAP_DIR" -name "*.bsp" -exec stat -c%s {} \; | awk '{s+=$1} END{print s}')
      TOTAL_BZ2_BYTES=$(find "$MAP_DIR" -name "*.bsp.bz2" -exec stat -c%s {} \; | awk '{s+=$1} END{print s}')
      # sound bytes
      TOTAL_SOUND_BYTES=$(find "$SOUND_DIR" \( -name "*.wav" -o -name "*.mp3" \) -exec stat -c%s {} \; | awk '{s+=$1} END{print s}')
      TOTAL_SOUND_BZ2_BYTES=$(find "$SOUND_DIR" \( -name "*.wav.bz2" -o -name "*.mp3.bz2" \) -exec stat -c%s {} \; | awk '{s+=$1} END{print s}')

      # fastdl url
      FASTDL_DWN_URL=$(grep -m1 "sv_downloadurl" "$SRCDS_DIR/$SERVER_GAME/cfg/server.cfg" | awk '{print $NF}' | tr -d '"')

      # map sizes
      MAP_BSP_HUMAN=$(human_size "$TOTAL_BSP_BYTES")
      MAP_BZ2_HUMAN=$(human_size "$TOTAL_BZ2_BYTES")
      # sound sizes
      SOUND_RAW_HUMAN=$(human_size "$TOTAL_SOUND_BYTES")
      SOUND_BZ2_HUMAN=$(human_size "$TOTAL_SOUND_BZ2_BYTES")

      # maps space saved
      if ((TOTAL_BSP_BYTES > 0)); then
        MAPS_SAVED_PERC=$(awk -v r="$TOTAL_BSP_BYTES" -v c="$TOTAL_BZ2_BYTES" \
          'BEGIN{printf "%.0f", ((r-c)/r)*100}')
      else
        MAPS_SAVED_PERC=0
      fi
      # sound space saved
      if ((TOTAL_SOUND_BYTES > 0)); then
        SOUND_SAVED_PERC=$(awk -v r="$TOTAL_SOUND_BYTES" -v c="$TOTAL_SOUND_BZ2_BYTES" \
          'BEGIN{printf "%.0f", ((r-c)/r)*100}')
      else
        SOUND_SAVED_PERC=0
      fi

      [[ "$FASTDL_DWN_URL" != */ ]] && FASTDL_DWN_URL="$FASTDL_DWN_URL/"

      # online check
      ONLINE_CHECK=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | head -n1 | xargs -n1 basename)
      # default
      FASTDL_STATUS="No maps"
      FASTDL_SPEED="N/A"
      FASTDL_USER="N/A"
      FASTDL_HOST="N/A"
      FASTDL_DIR="N/A"

      # if not found
      if [[ ! -f "$HOME"/bin/include/logs/fastdl.log ]]; then
        touch "$HOME"/bin/include/logs/fastdl.log
        # file age
        FILE_AGE="601"
      else
        # file age
        FILE_AGE="$(($(date +%s) - $(stat -c %Y "$HOME"/bin/include/logs/fastdl.log 2>/dev/null)))"
      fi

      if [[ -n "$ONLINE_CHECK" ]] && curl -fsI "$FASTDL_DWN_URL/maps/$ONLINE_CHECK" >/dev/null; then
        FASTDL_STATUS="OK"
        # if old enough
        if [[ "$FILE_AGE" -gt "600" ]]; then
          FASTDL_SPEED=$(curl -o /dev/null -s -w "%{speed_download}" "$FASTDL_DWN_URL/maps/$ONLINE_CHECK" | awk '{printf "%.1f KB/s",$1/1024}')
          # track value for average
          echo "$FASTDL_SPEED" >>"$HOME"/bin/include/logs/fastdl.log
          # average value
          echo "$(tail -10 "$HOME"/bin/include/logs/fastdl.log 2>/dev/null)" >"$HOME"/bin/include/logs/fastdl.log
        else
          FASTDL_SPEED="$(tail -1 "$HOME"/bin/include/logs/fastdl.log)"
        fi
        TOT_FASTDL_SPEED="$(awk '{sum += $1} END {print sum}' "$HOME"/bin/include/logs/fastdl.log 2>/dev/null)"
        TOT_FASTDL_SPEED_COUNT="$(wc -l "$HOME"/bin/include/logs/fastdl.log 2>/dev/null | awk '{ print $1 }')"
        AVG_FASTDL_SPEED="Average: $(echo "$TOT_FASTDL_SPEED/$TOT_FASTDL_SPEED_COUNT" | bc 2>/dev/null) KB/s"
      else
        FASTDL_STATUS="Offline, no maps on server!"
        AVG_FASTDL_SPEED=""
      fi

      # if any data
      if [[ -f "$HOME"/bin/include/logs/vps_user ]]; then
        FASTDL_USER="$(<"$HOME"/bin/include/logs/vps_user)"
      fi
      # if any data
      if [[ -f "$HOME"/bin/include/logs/vps_host ]]; then
        FASTDL_HOST="$(<"$HOME"/bin/include/logs/vps_host)"
      fi
      # if any data
      if [[ -f "$HOME"/bin/include/logs/vps_dir ]]; then
        FASTDL_DIR="$(<"$HOME"/bin/include/logs/vps_dir)"
      fi

      ##########################################################################

      FASTDL_OUTPUT="FastDL
├─Status......: $FASTDL_STATUS
├─User........: $FASTDL_USER
├─Host........: $FASTDL_HOST
├─Directory...: $FASTDL_DIR
├─Download....: $FASTDL_DWN_URL
└─Speed.......: $FASTDL_SPEED $AVG_FASTDL_SPEED

Maps
├─Total.......: $NUM_BSP
├─Compressed..: $NUM_BSP_BZ2 ($MAPS_COMP_PERC%)
├─Space Saved.: $MAPS_SAVED_PERC%
├─Size Raw....: $MAP_BSP_HUMAN (.bsp)
└─Size DL.....: $MAP_BZ2_HUMAN (.bz2)

Sounds
├─Total.......: $NUM_SOUND
├─Compressed..: $NUM_SOUND_BZ2 ($SOUND_COMP_PERC%)
├─Space Saved.: $SOUND_SAVED_PERC%
├─Size Raw....: $SOUND_RAW_HUMAN (.wav/.mp3)
└─Size DL.....: $SOUND_BZ2_HUMAN (.bz2)"

      dialog --msgbox "$FASTDL_OUTPUT" 0 0

      ;;

      ##########################################################################
      # compress maps
      ##########################################################################

    "2")

      compress_maps
      compress_sound

      # maps and sound
      MAPS=$(ls "$MAP_DIR"/*.bsp.bz2 2>/dev/null | wc -l)
      SOUND=$(find "$SOUND_DIR" -name "*.bz2" 2>/dev/null | wc -l)
      OUTPUT="$MAPS maps and $SOUND sound files compressed."
      WIDTH="$(echo "$(echo "$OUTPUT" | wc -L)+6" | bc 2>/dev/null)"

      dialog --msgbox "$OUTPUT" 5 "$WIDTH"
      ;;

      ##########################################################################
      # synchronize maps
      ##########################################################################

    "3")

      # default user cache
      VPS_USER_CACHE=""

      # if found
      if [[ -f "$HOME"/bin/include/logs/vps_user ]]; then
        # vps user cache
        VPS_USER_CACHE="$(cat "$HOME"/bin/include/logs/vps_user 2>/dev/null)"
      fi

      VPS_USER=$(dialog --inputbox "Enter VPS SSH username:" 8 40 "$VPS_USER_CACHE" 3>&1 1>&2 2>&3)
      # keep vps user cache
      echo "$VPS_USER" >"$HOME"/bin/include/logs/vps_user

      ##########################################################################

      # default host cache
      VPS_HOST_CACHE=""

      # if found
      if [[ -f "$HOME"/bin/include/logs/vps_host ]]; then
        # vps user cache
        VPS_HOST_CACHE="$(cat "$HOME"/bin/include/logs/vps_host 2>/dev/null)"
      fi

      VPS_HOST=$(dialog --inputbox "Enter VPS hostname or IP:" 8 40 "$VPS_HOST_CACHE" 3>&1 1>&2 2>&3)
      # keep vps host cache
      echo "$VPS_HOST" >"$HOME"/bin/include/logs/vps_host

      ##########################################################################

      # default vps dir
      if [[ ! -f "$HOME"/bin/include/logs/vps_dir ]]; then
        VPS_DIR_CACHE="/var/www/html/cstrike"
      fi

      VPS_FASTDL_DIR=$(dialog --inputbox "FastDL directory:" 8 50 "$VPS_DIR_CACHE" 3>&1 1>&2 2>&3)
      # keep vps dir cache
      echo "$VPS_FASTDL_DIR" >"$HOME"/bin/include/logs/vps_dir

      compress_maps
      compress_sound
      clear

      rsync -avz "$MAP_DIR/"*.bsp* "$VPS_USER@$VPS_HOST:$VPS_FASTDL_DIR/maps/"
      rsync -avz --include='*/' --include='*.bz2' --exclude='*' "$SOUND_DIR/" "$VPS_USER@$VPS_HOST:$VPS_FASTDL_DIR/sound/" 2>/dev/null

      dialog --msgbox "Maps and sound synchronized to FastDL server." 5 50
      ;;

      ##########################################################################
      # list maps and sound
      ##########################################################################

    "4")

      # change directory
      ncdu "$MAP_DIR"
      ncdu "$SOUND_DIR"
      ;;

    "0")

      clear
      return
      ;;
    esac
  done
}

# END
